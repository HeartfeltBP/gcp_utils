from gcp_utils.tools.preprocess import validate_window
from gcp_utils.tools.predict import predict_bp
from gcp_utils.tools.utils import format_as_json

CONFIG = dict(
    scaler_path='gcp_utils/data/mimic3-min-max-2022-11-08.pkl',
    checks=['snr', 'hr', 'beat'],
    fs=125,                                 # sampling frequency
    win_len=256,                            # window length
    freq_band=[0.5, 8.0],                   # bandpass frequencies
    sim=0.6,                                # similarity threshold
    snr=2.0,                                # SNR threshold
    hr_freq_band=[0.667, 3.0],              # valid heartrate frequency band in Hz
    hr_delta=1/6,                           # maximum heart rate difference between ppg, abp
    dbp_bounds=[20, 130],                   # upper and lower threshold for DBP
    sbp_bounds=[50, 225],                   # upper and lower threshold for SBP
    windowsize=1,                           # windowsize for rolling mean
    ma_perc=20,                             # multiplier for peak detection
    beat_sim=0.2,                           # lower threshold for beat similarity
)

RAW_VALID_SAMPLE = {
    'user_id': 'test',
    'sample_id': '123456789',
    'status': 'new',
    # 'ppg_raw': [-13.715496505544408,-13.790541099816494,-13.800868801654863,-13.706412780556258,-13.465752956754205,-13.062598393979314,-12.467132845565448,-11.651010001698417,-10.5948886582065,-9.298089024857985,-7.774221926602566,-6.01689100036137,-4.0570624223119145,-1.9371208787274687,0.3198913866917259,2.652474285694227,5.015062164322396,7.3606077200283355,9.629592484804773,11.769828059851516,13.755461047941743,15.529421831306642,17.070261341473635,18.35525343392644,19.380454447179314,20.136263080653237,20.624875565598,20.867890873220333,20.874626114039152,20.678057039998464,20.28457525802179,19.733366874935697,19.031642670953048,18.21158219764332,17.283900181508645,16.25141824970097,15.138687040937686,13.943827524020593,12.671181429258432,11.325043698941622,9.90470224083699,8.42147015204161,6.881235057598184,5.284253200240325,3.641493902569374,1.994567127659781,0.32380136854635877,-1.322070406453884,-2.9313259852123466,-4.481688874179999,-5.942314215489489,-7.298934538160335,-8.536223714995524,-9.635917727218592,-10.585841476095785,-11.383406592387944,-12.051676905256635,-12.567726534511326,-12.965685491246303,-13.25638122208043,-13.472679390630244,-13.613502501122252,-13.723225018035118,-13.808224611371763,-13.888298959075923,-13.979108796246958,-14.075392423683157,-14.178213951816506,-14.292115247463142,-14.380977623841149,-14.433173800335851,-14.420741153809903,-14.321065146352984,-14.086072809979331,-13.705135817236373,-13.134869105936994,-12.36458607543474,-11.364837548876817,-10.143026770528305,-8.68943537792492,-7.013005007500467,-5.152093348707039,-3.1113337745763006,-0.9508941601960479,1.2924555558346364,3.5760564184315164,5.847453062429418,8.049992882864654,10.149994767080688,12.093262455020774,13.854698734034045,15.3985675599309,16.71194313143116,17.778826437595363,18.587040104602277,19.17153170817159,19.506441316847443,19.62970548867706,19.5516248949416,19.298594188629785,18.884500512807936,18.328248061711538,17.652358321432864,16.855805862405997,15.973011544176456,14.9809839382761,13.907477444646153,12.74319657638128,11.502936850932969,10.171279326087781,8.769181450332926,7.2998871614675185,5.7600125428534055,4.186755262634048,2.5645374844081474,0.9305383329824912,-0.6780082621121419,-2.2810622384301924,-3.812201954392579,-5.281565304889748,-6.631978630577379,-7.87603011413143,-8.992748167069886,-9.955262730637171,-10.777870402966,-11.456514237092664,-11.996466381555447,-12.408881823317929,-12.70849022984882,-12.92520718659793,-13.061562610121841,-13.151284603835796,-13.204971164155547,-13.25336676904993,-13.287353521222244,-13.339650580780448,-13.384075191941207,-13.439337697892581,-13.482506851773866,-13.491386984354104,-13.453942774766126,-13.335324747302717,-13.11074668072434,-12.751090246723253,-12.224323210666975,-11.519263475225483,-10.601022285085484,-9.468051075139673,-8.118336163694645,-6.55297157340591,-4.784844375580514,-2.8496465413132315,-0.7638950422423947,1.4146646856146807,3.6576968405916563,5.901131109231461,8.105546548994063,10.224250116205015,12.201211366377292,14.007297134445764,15.606824966802424,16.976172039574514,18.098787983277912,18.964341991056372,19.578335134613884,19.946548488819374,20.084651838193327,20.004363588308077,19.737678006631576,19.293600388487032,18.709404612256964,17.992447970070266,17.1578638542262,16.23908129664246,15.222520030834803,14.134685991684032,12.962465177974654,11.728580639905488,10.420803299390293,9.043709280245592,7.608212288311382,6.11377001116888,4.568070122645608,2.992492345136424,1.3921718122415965,-0.20913654906935708,-1.7908560426527815,-3.3300289433112216,-4.809282451741197,-6.1912180490407795,-7.471198437368496,-8.624363870161636,-9.639966389245878,-10.503845416839871,-11.224539912809815,-11.804059843197352,-12.247147146139003,-12.573235575757113,-12.800093631987783,-12.948982767097453,-13.043911367397326,-13.098542827170922,-13.14595238297724,-13.184885056614391,-13.246841401458441,-13.310224858137953,-13.39838464799407,-13.480791587031172,-13.55133244144383,-13.58078726322963,-13.546189325459082,-13.405695567887587,-13.144163045082298,-12.708016528085675,-12.090354571630028,-11.255635184470169,-10.200720446873266,-8.907827533357846,-7.391932362412654,-5.666008353149906,-3.7520696970179035,-1.6894609024569798,0.48237633352842924,2.717100187020886,4.960331024939167,7.156059141333062,9.265975213856263,11.232536773956816,13.022321495630598,14.594578811059073,15.941130811029343,17.024346306103578,17.859757887600335,18.439329810007653,18.772468380607368,18.87625762998304,18.775009454527563,18.482887672238306,18.032909579520556,17.432198069080286,16.71804182075548,15.88926728015249,14.973567465972662,13.970034967110289,12.89204127832112,11.741879215711375,10.522363147103434,9.243099799171274,7.900329165853745,6.507862924181875,5.072186272944146,3.603765904434654,2.1155770212674287,0.6280963595009563,-0.8404291354393485,-2.2758843984728525],
    'ppg_raw': [-0.017258197,-0.016361266,-0.014650792,-0.013177723,-0.0120610595,-0.011393756,-0.011266887,-0.011709392,-0.012673438,-0.014070511,-0.015725493,-0.017408043,-0.01886046,-0.019752711,-0.019766122,-0.018629134,-0.016068399,-0.011877805,-0.005972892,0.0016396344,0.010848671,0.021410793,0.032973945,0.045104414,0.05731094,0.06911057,0.07994479,0.08933163,0.09698847,0.10258037,0.10590902,0.106984764,0.10589141,0.10282117,0.09806773,0.0919908,0.08498633,0.07748631,0.06981969,0.062290728,0.0552139,0.04868868,0.042740345,0.037386894,0.03251478,0.027958423,0.02354002,0.019073278,0.0143916905,0.009373039,0.0039643347,-0.0018445551,-0.007992685,-0.014323711,-0.020664275,-0.026797652,-0.03247556,-0.03747964,-0.041594505,-0.044661075,-0.046598434,-0.04737106,-0.04702416,-0.04567285,-0.043483615,-0.040678173,-0.037484854,-0.03413126,-0.030852407,-0.02784723,-0.025263697,-0.023207933,-0.021738857,-0.020865291,-0.020547688,-0.020723969,-0.021291465,-0.022134304,-0.023165435,-0.024283916,-0.025394052,-0.026448876,-0.027415454,-0.028269142,-0.029019684,-0.029680729,-0.03027299,-0.030829519,-0.031345546,-0.0318152,-0.03225845,-0.03262469,-0.032853276,-0.03291917,-0.032767385,-0.03235486,-0.031663805,-0.030700773,-0.029500097,-0.028137594,-0.026718736,-0.025342792,-0.024136633,-0.02325061,-0.022765607,-0.022722214,-0.023154318,-0.024008363,-0.025162995,-0.026444465,-0.0276137,-0.028410941,-0.028560132,-0.027734995,-0.025658637,-0.022141844,-0.016988486,-0.010104924,-0.0015418231,0.00858134,0.020012021,0.032384366,0.045256406,0.05812034,0.07045853,0.08177927,0.09156656,0.099438906,0.10519987,0.10863599,0.10969153,0.10850564,0.10528073,0.100307256,0.09396312,0.086657375,0.07880652,0.070827246,0.06302118,0.055639267,0.048898846,0.04283303,0.03739217,0.03249353,0.027972192,0.023619264,0.019219995,0.014587939,0.009573728,0.004090309,-0.0018881857,-0.008302748,-0.015022159,-0.021862924,-0.02858755,-0.03493455,-0.040638834,-0.045463145,-0.049210325,-0.051743433,-0.05301006,-0.053024128,-0.051893666,-0.049771428,-0.04686241,-0.043440387,-0.039743364,-0.036010772,-0.03247994,-0.029334188,-0.02669689,-0.024656922,-0.023245245,-0.022435546,-0.022188127,-0.022398293,-0.022951841,-0.023765773,-0.024715245,-0.025682688,-0.026602,-0.02741167,-0.02805677,-0.028503984,-0.028734177,-0.028738797,-0.028505176,-0.028028548,-0.027281731,-0.026245266,-0.024942815,-0.023343742,-0.021444708,-0.019302845,-0.016952425,-0.014466971,-0.011950314,-0.009508491,-0.007284969,-0.0054467916,-0.004146248,-0.003430456,-0.0033902228,-0.004133463,-0.005528152,-0.007413596,-0.009645581,-0.01196593,-0.014060855,-0.015602559,-0.01628831,-0.015828967,-0.013992459,-0.010597378,-0.005559653,0.0010818839,0.009224057,0.018637627,0.028984308,0.03985864,0.050789267,0.061282694,0.07086742,0.07911256,0.085693985,0.09032223,0.092839,0.09330377,0.091759145,0.08834827,0.083357066,0.07709432,0.069888294,0.062062502,0.053937525,0.0457893,0.037846714,0.030273527,0.023138106,0.016478062,0.010300189,0.004526943,-0.0009263158,-0.0061154366,-0.011103153,-0.015924633,-0.020573825,-0.025010943,-0.02915752,-0.03293416,-0.036208928,-0.038864702,-0.04084128,-0.042050898,-0.042458564,-0.04246521],
    'ppg': [0],
    'vpg': [0],
    'apg': [0],
    'ppg_scaled': [0],
    'vpg_scaled': [0],
    'apg_scaled': [0],
    'abp_scaled': [0],
    'abp': [0],
}

def config():
    return CONFIG

def raw_valid_sample():
    return RAW_VALID_SAMPLE

def processed_valid_sample():
    result = validate_window(RAW_VALID_SAMPLE['ppg_raw'], CONFIG)
    processed_valid_sample = {
        'user_id': 'test',
        'sample_id': '123456789',
        'status': 'valid',
        'ppg_raw': RAW_VALID_SAMPLE['ppg_raw'],
        'ppg': result['ppg'],
        'vpg': result['vpg'],
        'apg': result['apg'],
        'ppg_scaled': result['ppg_scaled'],
        'vpg_scaled': result['vpg_scaled'],
        'apg_scaled': result['apg_scaled'],
        'abp_scaled': [0],
        'abp': [0],
    }
    return processed_valid_sample

def predicted_sample():
    processed_sample = processed_valid_sample()
    data = format_as_json(processed_sample)
    result = predict_bp(data, CONFIG)
    predicted_sample = {
        'user_id': 'test',
        'sample_id': '123456789',
        'status': 'predicted',
        'ppg_raw': RAW_VALID_SAMPLE['ppg_raw'],
        'ppg': processed_sample['ppg'],
        'vpg': processed_sample['vpg'],
        'apg': processed_sample['apg'],
        'ppg_scaled': processed_sample['ppg_scaled'],
        'vpg_scaled': processed_sample['vpg_scaled'],
        'apg_scaled': processed_sample['apg_scaled'],
        'abp_scaled': result['abp_scaled'],
        'abp': result['abp'],
    }
    return predicted_sample
